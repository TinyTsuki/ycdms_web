<!doctype html>
<html xmlns:th="http://www.w3.org/1999/xhtml" lang="zh-cmn-Hans">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, shrink-to-fit=no"/>
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <link rel="shortcut icon" href="../static/favicon.png">

    <!-- MDUI CSS -->
    <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/mdui@1.0.0/dist/css/mdui.min.css"
            integrity="sha384-2PJ2u4NYg6jCNNpv3i1hK9AoAqODy6CdiC+gYiL2DVx+ku5wzJMFNdE3RoWfBIRP"
            crossorigin="anonymous"
    />
    <style>
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
    <title th:text="${clubInfo.clubTitle} + ' - 新生注册'"></title>
</head>
<body class="mdui-appbar-with-toolbar mdui-theme-accent-pink mdui-theme-primary-blue-grey mdui-theme-layout-auto">
<input type="hidden" th:value="${clubInfo.groupUrl}" id="groupUrl"/>
<input type="hidden" th:value="${clubInfo.groupNo}" id="groupNo"/>
<input type="hidden" th:value="${clubInfo.clubTitle}" id="clubTitle"/>
<input type="hidden" th:value="${clubInfo.botQQ}" id="botQQ"/>
<div class="mdui-appbar mdui-appbar-fixed mdui-color-theme">
    <div class="mdui-toolbar">
        <a href="javascript:;" class="mdui-typo-headline" th:text="${clubInfo.clubTitle}"></a>
        <a href="javascript:;" class="mdui-typo-title"> の 新生注册</a>
        <div class="mdui-toolbar-spacer"></div>
        <a th:href="${clubInfo.groupUrl}" target="_blank" class="mdui-btn mdui-btn-icon"
           mdui-tooltip="{content: '加入新生群'}"><i class="mdui-icon material-icons">group_add</i></a>
    </div>
</div>
<div class="mdui-container" style="max-width: 800px;">
    <form id="regForm" method="post" onsubmit="return sureReg(this)">
        <div class="mdui-typo">
            <blockquote>
                <p>注意事项：<br>
                    <span th:utext="${clubInfo.regTips}"></span>
                </p>
            </blockquote>
        </div>
        <div class="mdui-row" style=" margin-top: 32px;">
            <div class="mdui-col-xs-6">
                <label class="mdui-textfield-label">院系</label>
                <select class="mdui-select" id="series" name="series" onchange="serChange()">
                </select>
            </div>

            <div class="mdui-col-xs-6">
                <label class="mdui-textfield-label" style="text-align: left">专业</label>
                <select class="mdui-select" id="major" name="major" style="text-align: left">
                </select>
            </div>
        </div>

        <div class="mdui-row" style=" margin-top: 32px;">
            <div class="mdui-col-xs-6">
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">年级</label>
                    <input class="mdui-textfield-input" name="grade" th:value="${currentYear}"/>
                    <div class="mdui-textfield-helper" th:text="'只填数字，如：' + ${currentYear}"></div>
                </div>
            </div>
            <div class="mdui-col-xs-6">
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">班级</label>
                    <input class="mdui-textfield-input" type="number" name="classe"/>
                    <div class="mdui-textfield-helper">未分班填0</div>
                </div>
            </div>
        </div>

        <div class="mdui-row" style=" margin-top: 32px;">
            <div class="mdui-col-xs-6">
                <div class="mdui-textfield mdui-textfield-floating-label" style="padding-top: 0">
                    <label class="mdui-textfield-label">姓名</label>
                    <input class="mdui-textfield-input" name="name"/>
                </div>
            </div>
            <div class="mdui-col-xs-6">
                <label class="mdui-textfield-label">性别</label>
                <select class="mdui-select" mdui-select name="sex">
                    <option>请选择</option>
                    <option value="1">男</option>
                    <option value="2">女</option>
                </select>
            </div>
        </div>

        <div class="mdui-row" style=" margin-top: 32px;">
            <div class="mdui-col-xs-6">
                <label class="mdui-textfield-label">民族</label>
                <select class="mdui-select" mdui-select name="nation">
                    <option>阿昌族</option>
                    <option>白族</option>
                    <option>保安族</option>
                    <option>布朗族</option>
                    <option>布依族</option>
                    <option>藏族</option>
                    <option>朝鲜族</option>
                    <option>达斡尔族</option>
                    <option>傣族</option>
                    <option>德昂族</option>
                    <option>东乡族</option>
                    <option>侗族</option>
                    <option>独龙族</option>
                    <option>俄罗斯族</option>
                    <option>鄂伦春族</option>
                    <option>鄂温克族</option>
                    <option>高山族</option>
                    <option>仡佬族</option>
                    <option>哈尼族</option>
                    <option>哈萨克族</option>
                    <option selected>汉族</option>
                    <option>赫哲族</option>
                    <option>回族</option>
                    <option>基诺族</option>
                    <option>京族</option>
                    <option>景颇族</option>
                    <option>柯尔克孜族</option>
                    <option>拉祜族</option>
                    <option>黎族</option>
                    <option>傈僳族</option>
                    <option>珞巴族</option>
                    <option>满族</option>
                    <option>毛南族</option>
                    <option>门巴族</option>
                    <option>蒙古族</option>
                    <option>苗族</option>
                    <option>仫佬族</option>
                    <option>纳西族</option>
                    <option>怒族</option>
                    <option>普米族</option>
                    <option>羌族</option>
                    <option>撒拉族</option>
                    <option>畲族</option>
                    <option>水族</option>
                    <option>塔吉克族</option>
                    <option>塔塔尔族</option>
                    <option>土家族</option>
                    <option>土族</option>
                    <option>佤族</option>
                    <option>维吾尔族</option>
                    <option>乌孜别克族</option>
                    <option>锡伯族</option>
                    <option>瑶族</option>
                    <option>彝族</option>
                    <option>裕固族</option>
                    <option>壮族</option>
                </select>
            </div>
            <div class="mdui-col-xs-6">
                <label class="mdui-textfield-label">政治面貌</label>
                <select class="mdui-select" mdui-select name="politics">
                    <option>请选择</option>
                    <option value="1">群众</option>
                    <option value="2">团员</option>
                    <option value="3">党员</option>
                </select>
            </div>
        </div>

        <div class="mdui-row" style="padding-top: 32px">
            <div class="mdui-col-xs-6">
                <div class="mdui-textfield mdui-textfield-floating-label" style="padding-top: 0">
                    <label class="mdui-textfield-label">CN</label>
                    <input class="mdui-textfield-input" name="cn"/>
                    <div class="mdui-textfield-helper"></div>
                </div>
            </div>

            <div class="mdui-col-xs-6">
                <label class="mdui-textfield-label">意向部门</label>
                <select class="mdui-select" mdui-select name="department">
                    <option>请选择</option>
                    <option value="1">活动部</option>
                    <option value="2">技术部</option>
                    <option value="3">秘书部</option>
                    <option value="4">宣传部</option>
                    <option value="5">财务部</option>
                </select>
                <button class="mdui-btn mdui-btn-icon mdui-ripple" type="button" mdui-dialog="{target: '#example-1'}"><i
                        class="mdui-icon material-icons">help</i></button>
                <div class="mdui-dialog" id="example-1">
                    <div class="mdui-dialog-title">部门介绍：</div>
                    <div class="mdui-dialog-content">
                        <span th:text="${clubInfo.departmentInfo1}"></span>
                        <br>
                        <span th:text="${clubInfo.departmentInfo2}"></span>
                        <br>
                        <span th:text="${clubInfo.departmentInfo3}"></span>
                        <br>
                        <span th:text="${clubInfo.departmentInfo4}"></span>
                        <br>
                        <span th:text="${clubInfo.departmentInfo5}"></span>
                    </div>
                    <div class="mdui-dialog-actions">
                        <button type="button" class="mdui-btn mdui-ripple" mdui-dialog-confirm>确认</button>
                    </div>
                </div>

            </div>
        </div>

        <div class="mdui-row">
            <div class="mdui-col-xs-6">
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">QQ</label>
                    <input class="mdui-textfield-input" type="number" pattern="[1-9][0-9]{4,}" name="qq"/>
                    <div class="mdui-textfield-error">请输入正确的QQ号码，QQ号码为新生注册的主要凭据</div>
                    <div class="mdui-textfield-helper">QQ号码为新生注册的主要凭据</div>

                </div>
            </div>
            <div class="mdui-col-xs-6">
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">手机号</label>
                    <input class="mdui-textfield-input" type="number" pattern="1[3,4,5,8]\d[\s,-]?\d{4}[\s,-]?\d{4}"
                           name="phone"/>
                    <div class="mdui-textfield-error">请输入11位手机号码</div>
                </div>
            </div>
        </div>
        <div class="mdui-row">
            <div class="mdui-col-xs-6">
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">寝室楼栋数</label>
                    <input class="mdui-textfield-input" type="number" name="tung"/>
                </div>
            </div>
            <div class="mdui-col-xs-6">
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">寝室号</label>
                    <input class="mdui-textfield-input" type="number" name="room"/>
                </div>
            </div>
        </div>
    </form>
    <div style="margin-bottom: 80px;margin-top: 16px">
        <button class="mdui-btn mdui-color-theme-accent mdui-btn-raised" style="float: right" onclick="sureReg()"
                id="sub_button">立即注册
        </button>
    </div>

</div>

<!-- MDUI JavaScript -->
<script
        src="https://cdn.jsdelivr.net/npm/mdui@1.0.0/dist/js/mdui.min.js"
        integrity="sha384-aB8rnkAu/GBsQ1q6dwTySnlrrbhqDwrDnpVHR2Wgm8pWLbwUnzDcIROX3VvCbaK+"
        crossorigin="anonymous"
></script>
<script>
    var $ = mdui.$;
    var list = '';
    var major_sel = new mdui.Select('#major');
    var qq = '';
    $.ajax({
        method: 'GET',
        url: '../static/college_list.json',
        success: function (data) {
            var ser = '';
            data = JSON.parse(data);
            list = data;
            console.log(data)
            for (const dataKey in data) {
                console.log(dataKey)
                ser += '<option value="' + dataKey + '">' + data[dataKey].name + '</option>';
            }
            console.log(ser);
            $("#series").html(ser);
            new mdui.Select('#series');
            serChange();
        }
    });

    function getQueryVariable(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] === variable) {
                return pair[1];
            }
        }
        return false;
    }

    function serChange() {
        var datakey = $("#series").val();
        var maj = '';
        for (const name in list[datakey].list) {
            maj += '<option>' + list[datakey].list[name] + '</option>';
        }
        $("#major").html(maj);
        major_sel.handleUpdate();
    }

    function sureReg() {
        $("#sub_button").attr("disabled", "disabled");
        let params = $('#regForm').serializeArray();
        let paramsKey = 0;
        for (paramsKey in params) {
            if (params[paramsKey].value === '' || params[paramsKey].value === '请选择') {
                mdui.snackbar({message: '请填写完页面所有信息'});
                $("#sub_button").removeAttr("disabled");
                return false;
            }
            if (params[paramsKey].name === 'phone') {
                if (params[paramsKey].value.length !== 11) {
                    mdui.snackbar({message: '请输入11位手机号'});
                    $("#sub_button").removeAttr("disabled");
                    return false;
                }
            }
            if (params[paramsKey].name === 'qq') {
                qq = params[paramsKey].value;
            }
            if (params[paramsKey].name === 'series') {
                params[paramsKey].value = list[params[paramsKey].value].name;
                console.log(params[paramsKey].value);
            }
        }
        params.push({name: 'token', value: getQueryVariable('token')})
        let postdata = $.param(params);
        $("#sub_button").removeAttr("disabled");
        mdui.dialog({
            title: '<i class="mdui-icon material-icons">warning</i>重要事项',
            content: '请确认您输入的QQ号码 [ <b>' + qq + '</b> ] 准确无误，核对后请点击确定',
            modal: true,
            closeOnEsc: false,
            buttons: [
                {
                    text: '取消'
                },
                {
                    text: '确认',
                    onClick: function (inst) {
                        $("#sub_button").attr("disabled", "disabled");
                        $.ajax({
                            method: 'POST',
                            url: '/api/Member/regNewUser',
                            data: postdata,
                            success: function (data) {
                                data = JSON.parse(data);
                                if (data.code !== 1) {
                                    mdui.alert(data.msg, '注册失败');
                                } else {
                                    mdui.dialog({
                                        title: '注册成功！',
                                        content: ' <div class="mdui-typo">会员编号[' + data.data.id + ']，欢迎您加入' + $("#clubTitle").val() + '！<br>到此您已正式加入社团，让我们一起开心的玩耍叭！<br>请添加社团新生群 <a target="_blank" href="' + $("#groupUrl").val() + '">' + $("#groupNo").val() + '</a> 以及社团助理机器人QQ ' + $("#botQQ").val() + ' </div>',
                                        buttons: [
                                            {
                                                text: '确认'
                                            },
                                            {
                                                text: '加新生群',
                                                onClick: function (inst) {
                                                    window.open($("#groupUrl").val());
                                                }
                                            }
                                        ]
                                    });
                                }
                                $("#sub_button").removeAttr("disabled");
                            },
                            error: function (xhr, textStatus) {
                                console.log(xhr)
                                console.log(textStatus)
                                mdui.alert('土豆服务器被老鼠吭了导致无法处理...<br>建议重新提交可能会解决遇到的这个错误<br>' + textStatus + ': [' + xhr.status + ']' + xhr.statusText, '网络错误');
                                $("#sub_button").removeAttr("disabled");
                            }
                        });
                    }
                }
            ]
        });
        console.log(postdata);

        return false;
    }
</script>
</body>
</html>